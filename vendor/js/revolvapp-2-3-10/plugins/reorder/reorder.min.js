Revolvapp,Revolvapp.add("plugin","reorder",{defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m3 5h10c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-10c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1zm0 4h10c.5522847 0 1 .44771525 1 1 0 .5522847-.4477153 1-1 1h-10c-.55228475 0-1-.4477153-1-1 0-.55228475.44771525-1 1-1z"/></svg>'},subscribe:{"component.set":function(){this._observe()}},init:function(){},start:function(){this.app.control.add("reorder",{icon:this.opts.reorder.icon,position:"first",except:["header","main","footer","column","table-row","table-cell"]})},stop:function(){this._stopEvents()},_observe:function(){this.$btn=this.app.control.get("reorder"),0!==this.$btn.length&&(this.$btn.addClass(this.prefix+"-handle"),this._sortable())},_sortable:function(){this._buildInstance(this.app.component.get()),this.coreParent=this.parent,this.$win=this.app.editor.getWin(),this.tolerance=this.$btn.width(),this.$clickItem=null,this.$dragItem=null,this.oldY=0,this.dragging=!1,this.$btn.on("mousedown."+this.prefix+"-reorder touchstart."+this.prefix+"-reorder",this._press.bind(this))},_press:function(t){var e=this.dom(t.target).closest(".rex-button");t&&t.target&&e.hasClass("rex-handle")&&(t.preventDefault(),this.$win.on("mouseup."+this.prefix+"-reorder touchend."+this.prefix+"-reorder",this._release.bind(this)),this.$win.on("mousemove."+this.prefix+"-reorder touchmove."+this.prefix+"-reorder",this._move.bind(this)),e=this.instance.getElement().get(),this.app.component.unset(),this.dragging=!0,this.$dragItem=this._makeDragItem(e,t.target))},_release:function(t){this._stopEvents(),this.coreParent.isEmpty()&&this.coreParent.remove(),this.app.observer.trigger=!0,this.app.observer.sync(this.$clickItem),this.oldY=0,this.dragging=!1,this._trashDragItem()},_move:function(t){if(this.$dragItem||this.dragging){t.preventDefault(),this.app.observer.trigger=!1;var e=this.app.editor.getFrameRect(),i=!1,s=0===this.oldY?0:this.oldY-t.pageY,r=(0<s?i="up":s<0&&(i="down"),this.app.scroll.isTarget()),o=this._isFrameScroll(),h=this.app.$doc.scrollTop(),a=r?this.app.scroll.getTarget():this.app.$doc,n=(o?this.app.editor.getDoc():a).scrollTop();this._moveItem(this.$dragItem,s),this.oldY=t.pageY;var p,s=!1,r=(r?p=a.height()+a.offset().top-40:o?(p=e.bottom-40,(endWin=this.app.$win.height()+h-40)<p&&(p=endWin)):(s=!this.app.toolbar.isSticky(),p=this.app.$win.height()+n-40),this.app.container.get("toolbar")),a=r.height(),h=o?t.pageY+e.top-n:t.pageY+e.top,o=r.offset().top+a+40,t=("up"===i&&0<n&&h<o&&!1===s?this._scroll(-10):"down"===i&&p<h&&this._scroll(10),"layer"===this.parentType&&["block"]),e=!("column"===this.parentType),c=this.parent.getElements(t,["grid","column"],e),l=c.length;if("block"===this.parentType)for(var r=this.parent.getParent("layer"),g=this.parent.getElement(),d=r.getElements(["block","grid"]),m=0;m<d.length;m++){var f,u,v,$,b=d.eq(m).get();b!==this.$clickItem.get()&&b!==g.get()&&this._isOver(this.dom(b))&&(f="up"===i?"append":"prepend",u=(b=this.dom(b).dataget("instance")).getTarget(),v=b.getSource(),"grid"===b.type&&(u=b.$element,f="up"===i?"after":"before"),$=(b=this.$clickItem.dataget("instance")).getSource(),u[f](this.$clickItem),v[f]($),this._buildInstance(b))}for(var _=0;_<l;_++){var I=c.eq(_).get();I!==this.$clickItem.get()&&this._isOver(this.dom(I))&&this._swapItems(I)}}},_scroll:function(t){var e=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.$win,i=(e=this._isFrameScroll()?this.app.editor.getWin():e).scrollTop();e.scrollTop(i+t)},_buildInstance:function(t){this.instance=t;t=this.instance.getType();this.parentType="block"===t?"layer":"block",this.instance.getParent("column")&&(this.parentType="column"),this.parent="layer"===this.parentType?this.instance.getParent("layer"):this.instance.getParent(this.parentType)},_swapItems:function(t){var e=this.$dragItem.offset().top,i=this.$clickItem,t=this.dom(t),s=i.dataget("instance"),r=t.dataget("instance"),s=s.getSource(),r=r.getSource(),o=t.offset(),o=t.height()/2+o.top>e?"before":"after";t[o](i),r[o](s)},_stopEvents:function(){this.$win&&(this.$btn.off("."+this.prefix+"-reorder"),this.$win.off("."+this.prefix+"-reorder"))},_isFrameScroll:function(){return this.app.editor.getFrame().height()<this.app.editor.getBody().height()},_isOver:function(t){var e=this.$dragItem.offset().top,i=t.offset(),t=t.height();return e>i.top&&e<i.top+t},_moveItem:function(t,e){var i=t.offset().top;t.css("top",(i-=e)+"px")},_makeDragItem:function(t){this._trashDragItem();var t=this.dom(t),e=t.offset(),i=(this.$clickItem=t,this.$clickItem.addClass(this.prefix+"-drag-active"),t.clone()),s=(i.removeClass(this.prefix+"-drag-active "+this.prefix+"-element-active"),this.dom("<div>").addClass(this.prefix+"-dragging"));return s.append(i),s.css({opacity:.95,position:"absolute","z-index":999,left:e.left+"px",top:e.top+"px",width:t.width()+"px"}),this.app.editor.getBody().append(s),s},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass(this.prefix+"-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}});