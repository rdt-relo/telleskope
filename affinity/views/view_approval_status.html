<style>
    .approval-heading {
        font-size: 14px;
        padding-left: 20px;
        margin: 0.4em 0;
    }
    .approval-section {
        font-size: 14px;
        width 100%;
        padding: 0 20px;
    }
    .approval-section-sub-block {
        border: 1px solid #efefef;
        border-radius: 4px;
        background: #fcfcfc;
    }

    .approval-timeline {
        border-left: 4px solid #4298C3;
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        background: rgb(87 78 78 / 3%);
        color: rgb(0 0 0);
        margin: 30px 20px;
        position: relative;
        line-height: 1.2em;
        font-size: 14px;
        padding: 50px 50px 50px 10px;
        list-style: none;
        text-align: left;
        font-weight: 100;
        max-width: 100%;
        height: 450px;
        overflow: scroll;
    }

    .approval-timeline h1, .approval-timeline h2, .approval-timeline h3 {
        font-size: 1em;
    }

    .approval-timeline-event {
        border-bottom: 1px dashed rgba(0, 0, 0, 0.5);
        padding-bottom: 25px;
        margin-bottom: 50px;
        position: relative;
        padding-left: 20px;
    }

    .approval-timeline-event:last-of-type {
        padding-bottom: 0;
        margin-bottom: 0;
        border: none;
    }

    .approval-timeline-event:before, .approval-timeline-event:after {
        position: absolute;
        display: block;
        top: 0;
    }

    .approval-timeline-event:before {
        left: 18px;
        color: rgb(14 15 15);
        content: attr(data-date);
        text-align: right;
        font-weight: 500;
        font-size: 1.2em;
        top: -30px;
        min-width: 120px;
    }

    .approval-timeline-event:after {
        box-shadow: 0 0 0 4px #4298c3;
        left: -16.85px;
        background: #313534;
        border-radius: 50%;
        height: 11px;
        width: 11px;
        content: "";
        top: 5px;
    }
</style>
<div class="modal" id="approvalStatusModal" tabindex="-1">
    <div class="modal-dialog modal-lg" aria-modal="true" role="dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title" tabindex="0" class="modal-title"><?= gettext($topicTypeLabel.' Approval Detail');?></h2>
          <button id="btn_close" type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="col-md-12 text-center" id="speakerDetail">
            <!-- Add a note container -->
            <div id="note-container">
              <button id="add-note-button" class="btn btn-primary"><?= gettext('Add a note');?></button>
              <!-- Textarea and Save button (hidden by default) -->
              <form onsubmit="addCommonNote(event, '<?=$topicType?>')">
                  <div class="col-sm-12 form-group">
                  <input type="hidden" id="topicTypeId" value="<?= $enc_topictype_id ?>" name="topicTypeId">
                  <input type="hidden" id="topicType" value="<?= $topicType ?>" name="topicType">
                  
                  <div id="note-form" class="mt-3" style="display: none;"> 
                    <p> <?= gettext('Required fields are marked with an asterisk (<span aria-hidden="true" style="color: #ff0000;">*</span>).')?></p>
                    <p><label for="note-textarea"><?= gettext('Add a note');?><span style="color: #ff0000;"> *</span></label> </p>                  
                      <textarea id="note-textarea" maxlength="1000" placeholder="Write your note here ..." rows="4" cols="74%" name="note" aria-required="true"></textarea>
                      <br>
                      <small style="color:red">Maximum 1000 characters allowed!</small>
                      <br>

                      <?= TopicApprovalLog::CreateEphemeralTopic()->renderAttachmentsComponent('v26') ?>
                      <button id="close-note-button" type="button" class="btn btn-secondary">Cancel</button>
                      <button id="save-note-button" type="submit" class="btn btn-primary"><?= gettext('Save note');?></button>
                      <hr>
                  </div>
                  </div>
              </form>
            </div>
            <div class="mt-3">
                <?= gettext('Approval Status'); ?>
                <span class="<?= Approval::STATUS_LABEL_CSS_CLASS_MAP[$approval->val('approval_status')] ?> px-2 py-1">
                  <?= ucwords($approval->val('approval_status')); ?>
                  <?= in_array($approval->val('approval_status'), [Approval::TOPIC_APPROVAL_STATUS['PROCESSING'], Approval::TOPIC_APPROVAL_STATUS['REQUESTED']]) ? (''. gettext(' Stage ') . $approval->val('approval_stage')) : ''; ?>
                </span>
            </div>
            <div>
                <ul class="approval-timeline">
                    <?php foreach(array_reverse($approvalNotes) as $anote_obj){
                        $anote = $anote_obj->toArray();
                        $eventActionDate = $_USER->formatUTCDatetimeForDisplayInLocalTimezone($anote['createdon'], true, true, true)
                       ?>
                    <li class="approval-timeline-event" data-date="<?= $eventActionDate ?>">
                      <p>
                          <strong><?= gettext('Stage') . $anote['approval_stage'];?></strong> : <?= ucfirst(htmlspecialchars($anote['log_title']));?>
                      </p>

                      <?php if (!empty($anote['log_notes'])) { ?>
                      <p class="pt-3">
                          <?= (htmlspecialchars($anote['log_notes']));?>
                      </p>
                      <?php } ?>

                      <?= $anote_obj->renderAttachmentsComponent('v25') ?>
                    </li>
                <?php } ?>
                  </ul>
            </div>
          </div>
          <?= $approval->renderAttachmentsComponent('v18') ?>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="clearInterval(__globalIntervalVariable);"><?= gettext('Close');?></button>
        </div>
      </div>
    </div>
  </div>
  <script>
    $('#approvalStatusModal').on('shown.bs.modal', function () {
      $('#btn_close').trigger('focus')
    });
    </script>
<script>
  $(document).ready(function() {
      // Toggle visibility of textarea and Save button on Add a note button click
      $("#add-note-button").click(function() {
          $("#note-form").toggle();
          $("#add-note-button").hide();
      });
      $("#close-note-button").click(function() {
            $("#note-form").toggle();
            $("#add-note-button").show();
        });
  });

  function addCommonNote(jsevent, topicType)
  {
    jsevent.preventDefault();
      var note = $("#note-textarea").val();
      if (note.length < 2) {
          swal.fire({title: "Error", text: "A minimum of two character note is required"});
          return;
      }
          var topicTypeId = '<?= $enc_topictype_id ?>';
          $.ajax({
              url: "ajax_approvals.php?saveTopicApprovalNote=1",
              method: "POST",
              data: $(jsevent.target).serialize(),
              success: function (data) {
                    try {
                        let jsonData = JSON.parse(data);
                        swal.fire({title: jsonData.title, text: jsonData.message}).then(function (result) {
                            if (jsonData.status == 1) {
                                $("#note-form").hide();
                                $("#add-note-button").toggle();
                                $('#approvalStatusModal').modal('hide');
                                $('body').removeClass('modal-open');
                                $('.modal-backdrop').remove();
                                $('#loadAnyModal').html('');
                              // Reload the modal
                              viewApprovalStatus(topicTypeId,topicType);
                            }
                        });
                    } catch (e) {
                        swal.fire({title: 'Error', text: "Unknown error."});
                    }
                    setTimeout(() => {
                      $(".swal2-confirm").focus();
                  }, 100);
                },
                tskp_submit_btn: $(jsevent.target).find('[type="submit"]')
          });
  }
  </script>

