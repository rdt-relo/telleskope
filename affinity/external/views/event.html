<!DOCTYPE html>
<html lang="en">

<head>
    <title>External Event</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="96x96" href="<?= Url::GetFavIconUrl(); ?>">

    <!-- Bootstrap -->
    <link href="../vendor/js/bootstrap-4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../vendor/css/animate-3.7.2.min.css" rel="stylesheet">

    <link href="../vendor/js/bootstrap-multiselect/dist/css/bootstrap-multiselect.css" rel="stylesheet">
    <link href="../vendor/js/jquery-ui-1.14.0/themes/ui-lightness/jquery-ui.min.css" rel="stylesheet">

    <!-- Teleskope styles, comes after bootstrap from parent folder -->
    <link href="../css/hems.css?<?=REL_HASH?>" rel="stylesheet">
    <link href="../../css/teleskope.css" rel="stylesheet">
    <link href="../css/affinity.css?<?=REL_HASH?>" rel="stylesheet">
    <link href="../../vendor/fonts/fontawesome-free-5.12.0-web/css/all.min.css" rel="stylesheet">

    <!-- Bootstrap ... in the last -->
    <script src="../vendor/js/jquery-3.5.1/dist/jquery.min.js"></script>
    <script src="../vendor/js/jquery-ui-1.14.0/jquery-ui.min.js"></script>
    <script src="../vendor/js/bootstrap-4.4.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../vendor/js/bootstrap-multiselect/dist/js/bootstrap-multiselect.js"></script>

    <script defer type="text/javascript" src="../vendor/js/popconfirm-0.4.3/jquery.popconfirm.tele.2023.11.15.js"></script>

    <script src="../vendor/js/initial-0.2.0/dist/initial.min.js"></script>

    <!-- select2 -->
    <link href="../vendor/js/select2-4.0.12/dist/css/select2.min.css" rel="stylesheet" />
    <script defer src="../vendor/js/select2-4.0.12/dist/js/select2.min.js"></script>
    <!-- end of select 2 -->

    <!-- Survey.js -->
    <!-- <link rel="stylesheet" href="../vendor/js/surveyjs-1.9.50/survey.min.css"> -->
    <link rel="stylesheet" href="../vendor/js/surveyjs-1.11.2/defaultV2.css">
    <link href="../vendor/js/surveyjs-1.11.2/modern.min.css" rel="stylesheet">
    <script src="../vendor/js/surveyjs-1.11.2/survey.jquery.min.js"></script>

    <!-- Sweet Alert 2 -->
    <script src="../vendor/js/sweetalert2/dist/sweetalert2.all.min.js"></script>
    <style>
        body {
            background-color: #ffffff !important;
        }

        .green:before {
            background-color: <?=($group && $_ZONE->val('show_group_overlay')) ? $group->val('overlaycolor'): '';
            ?>;
        }

        .timepicker {
            z-index: 9999 !important;
        }

        .rsvpbtn {
            margin: 5px;
        }

        .rsvpbtn:disabled {
            font-weight: 900;
        }

        .rsvpbtn:not(:disabled) {
            background-color: floralwhite;
        }

        .rsvpbtn:hover:not(:disabled) {
            box-shadow: 0 0 11px rgba(33, 33, 33, .4);
            color: grey;
        }

        .dropdown-menu.dropmenu {
            left: 50% !important;
        }

        .dropdown-item {
            cursor: pointer;
        }
    </style>

</head>

<body>
    <div class="jumbotron text-center pt-0" style="background: #fff; border-bottom: 1px solid rgb(201, 199, 199);">
      <div class=" col-md-12 mt-2">
        <?php if ($external_user){ ?>
          <ul class="nav flex-row order-lg-2 ml-auto nav-icons pull-right">
            <li class="nav-item dropdown user-dropdown align-items-center">
                <a class="nav-link text-dark" href="#" id="dropdown-user" role="button" data-toggle="dropdown" aria-expanded="false">
                    <span class="ml-2 h-lg-down dropdown-toggle"> <i class="fa fa-user-circle"></i></span> <?= $external_user['firstname']; ?> <?= $external_user['lastname']; ?> â–¾
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdown-user">
                    <a class="dropdown-item" href="javascript:void(0);" onclick="clearExternalEventSession()">Logout</a>
                </div>
            </li>
        </ul>
      <?php } ?>
      </div>
        <img src="<?=$_COMPANY->val('logo')?>" height="40px" />
        <p>
            <?=$_COMPANY->val('companyname')?>
        </p>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-sm-12 pb-5">
                <h3 class="text-center">
                    <?= sprintf(gettext('%s Detail'),$event->val('eventtitle'));?>
                </h3>
            </div>
            <div class="col-sm-12 mb-5">
                <div class="row">
                <?php if($rsvpOptions['my_rsvp_status']){ ?>
                    <div class="col-md-12 text-right">
                      <a class="btn-link js-download-link" href="ajax?downloadICSFile=<?= aes_encrypt(json_encode($params), TELESKOPE_USERAUTH_API_KEY, 'u7KD33py3JsrPPfWCilxOxojsDDq0D3M', false)?>"><i class="fa fa-download" aria-hidden="true"></i> .ics file</a>
                    </div>
                <?php } ?>
                  
                    <!-- Second Row Start -->
                    <div class="col-md-12">
                        <span class="dta-tm">
                        <span class="dta-tm">
                            <?= gettext("Published on"); ?>
                            <?= $db->covertUTCtoLocalAdvance('Y-m-d H:i'," T(P)",  $event->val('publishdate'), $timezone); ?>
                        
                          <?php if ($event->val('chapterid')) { ?>
                            in
                          <?php foreach(explode(',',$event->val('chapterid')) as $chid){ ?>
                            <?php 	$c = Group::GetChapterName($chid,$event->val('groupid')); ?>
                              <span class="chapter-label" style="color:<?= $c['colour'] ?>">
                                <i class="fas fa-globe" style="color:<?= $c['colour'] ?>" aria-hidden="true"></i>&nbsp;<?= $c['chaptername']; ?>
                              </span> &nbsp;
                        <?php } ?>
                        <?php } ?>
                        <?php 
                          if ($event->val('channelid') > 0){ 
                            $ch = Group::GetChannelName($event->val('channelid'),$event->val('groupid'));        
                        ?>
                        <span class="chapter-label ml-1" style="color:<?= $ch['colour'] ?>"><i class="fas fa-layer-group" style="color:<?= $ch['colour'] ?>" aria-hidden="true"></i>&nbsp;<?= htmlspecialchars($ch['channelname']); ?></span>
                        <?php
                          }
                        ?>
                      </span>
                    </div>
                    <!-- Second Row End -->
                    <!-- Event Joinrow Start -->
                    <?php if ($event->isPublished() && $event->hasRSVPEnded() && !$event->hasEnded()){ ?>
                    <div class="alert alert-info" style="margin: 10px auto 30px auto;">
                        <div align="center" style="font-weight: 900">
                            <p>
                                <?=$rsvpOptions['message']?>
                            </p>
                        </div>
                    </div>

                    <?php } elseif ($event->isPublished() && !$event->hasEnded()){ ?>
                    <div class="col-md-12" id="joinevent">
                        <div class="alert alert-<?=$btnCss[$userRsvpStatus %10]?>">
                            <p style="font-size: smaller;">
                                <?=$rsvpOptions['message']?>
                            </p>
                            <?php if (!empty($rsvpOptions['buttons'])) { ?>
                            <div align="center" style="margin: 10px auto;font-weight: 900">
                                <p>
                                    <?= gettext("Will you be attending this event?"); ?>
                                </p>
                            </div>
                            <?php } ?>
                            <div align="center">
                                <?php foreach ($rsvpOptions['buttons'] as $rsvpId => $buttonLabel) {
                                    $outline = ($userRsvpStatus == $rsvpId) ? '' : 'outline-';
                                    $joinFunction = "joinExternalEvent";
                                    if ($event->isEventSurveyAvailable(Event::EVENT_SURVEY_TRIGGERS['EXTERNAL_PRE_EVENT'])){
                                      $joinFunction = "getPreJoinExternalEventSurvey";
                                    }
                                ?>
                                        <button class="btn btn-sm btn-<?= empty($rsvpOptions['buttons']) ? 'secondary' :  $outline.$btnCss[$rsvpId %10]?> rsvpbtn"
                                          <?php if(empty($outline)){ ?>
                                            disabled
                                          <?php }else{ ?>
                                            onclick="<?= $joinFunction; ?>('<?= $enc_eventid ?>', '<?= $rsvpId; ?>')"
                                          <?php } ?>
                                        >
                                          <?=$buttonLabel?>
                                        </button>
                                <?php } ?>
                                <?php if($event->val('add_photo_disclaimer') && $_COMPANY->getAppCustomization()['event']['photo_disclaimer']['enabled']){ ?>
                                <p><small><?= $_COMPANY->getAppCustomization()['event']['photo_disclaimer']['disclaimer']; ?></small></p>
                                <?php } ?>
                            </div>
                        </div>
                    </div>
                    <?php } ?>
                    <!-- Event Joinrow End -->
                  <?php if(0 && $external_user && $_COMPANY->getAppCustomization()['event']['volunteers'] && $event->isPublished() && !$event->hasEnded() && !empty($eventVolunteerRequests)){ ?>
                    <div class="col-12 p-0 m-0" id="manage_volunteer_enrollment">
                      <?php include_once __DIR__.'/init_external_event_volunteers.widget.php'; ?>
                    </div>
                  <?php } ?>

                    <!-- Time a location block start -->
                    <div class="col-md-12 event-venue-section">

											<span aria-label="Time" role="img" class="fa fa-clock tele-title-icon"></span>
											<div class="tele-title" style="width:100% !important">
												<p class="font-col">
													<?= $db->covertUTCtoLocalAdvance("l", "",  $event->val('start'),$timezone); ?>
													<br>
													<?= $db->covertUTCtoLocalAdvance("M j, Y g:i a","",  $event->val('start'),$timezone) ;?>
													-
													<?= ($event->getDurationInSeconds() > 86400 ? $db->covertUTCtoLocalAdvance("M j, Y g:i a", "",  $event->val('end'),$timezone) : $db->covertUTCtoLocalAdvance("g:i a", "",  $event->val('end'),$timezone))?>
													<br>
													<?= $db->covertUTCtoLocalAdvance("T", "",  $event->val('end'),$timezone); ?>
												</p>
											</div>

											<?php if (!empty($event->val('event_contact')) && strlen($event->val('event_contact')) > 1) { ?>
											<span class="fa fa-user tele-title-icon"></span>
											<div class="tele-title">
												<p class="font-col">
													<?= htmlspecialchars($event->val('event_contact')); ?>
												</p>
											</div>
											<?php } ?>

										<?php if($event->val('event_attendence_type')!=4) { ?>
										<div class="">

											<?php if($event->val('event_attendence_type')!=1 && !empty($event->val('web_conference_link'))) { ?>
												<i aria-label="Meeting Platform" role="img" class="fa fa-laptop tele-title-icon" aria-hidden="true"></i>
												<div class="tele-title">
													<a class="link_show" target="_blank" rel="noopener" href="<?= $event->getWebConferenceLink()?>" ><strong><?= $event->val('web_conference_sp'); ?></strong></a>
													&nbsp;
													<?php if ($event->val('web_conference_detail')){ ?>
														<a href="javascript:void(0);" onclick='showWebConferenceDetail()' class="link_show small">[details]</a>
													<?php } ?>
												</div>
                            <div class="col-md-12 my-2 p-3" id="conference_detail" style="background-color: #efefef;display: none;">
                                <?=$event->val('web_conference_detail')?>
                            </div>
											<?php } ?>
											<?php if ($event->val('event_attendence_type') !=2){
													if ($event->val('latitude')) {
														$map_location = $event->val('latitude') . ',' . $event->val('longitude');
													} else {
														$map_location = $event->val('vanueaddress');
													}
												?>
												<span aria-label="Location" role="img" class="fa fa-map-marker map-in tele-title-icon"></span>
												<div class="tele-title">
													<p class="font-col"><?= $event->val('eventvanue'); ?><a class="link_show small" target="_blank"  href="https://www.google.com/maps/?q=<?= $map_location; ?>" >&nbsp;[<?= gettext("map"); ?>]</a></p>
                                                    <?php if (!empty($event->val('venue_room'))) { ?><p><?= $event->val('venue_room'); ?></p><?php } ?>
                                                    <p><?= $event->val('vanueaddress'); ?></p>
                                                    <?php if (!empty($event->val('venue_info'))) { ?><p><?= $event->val('venue_info'); ?></p><?php } ?>
												</div>
											<?php } ?>
										</div>
										<?php } ?>
									</div>

                    <!-- Time a location block end -->

                    <!-- Start event details -->
                    <div class="col-md-12 evet-description">
                        <div id="post-inner">
                            <?= $event->val('event_description'); ?>
                        </div>
                    </div>
                    <!-- End event details -->
                    <!--Start show pictures of event joiners -->
                    <div class="col-md-12 bg-color">
                        <hr class="hr">
                        <?php if($event->hasEnded() && !$event->isDraft() && !$event->isUnderReview() ){
                            $canAddUpdate = false;
                            $hidden = "";
                            if(!$canAddUpdate && $event->val('followup_notes')){ 
                              $hidden = "hidden";
                            }
                        ?>
                        <div class="evet-description">
                            <div id="post-inner">
                              <?php if ($event->val('followup_notes')){ ?>
                                <?= $event->val('followup_notes'); ?>
                              <?php } ?>
                            </div>
                        </div>
                        <hr class="hr <?= $hidden; ?>">
                        <?php } ?>
                        <!-- <p>
                            <strong><?=  $joinersCount; ?> <?= ($event->hasEnded()) ? gettext("RSVP'd") : gettext('People going') ?></strong><br><br>
                        </p> -->

                        <!-- Check for RSVP settings -->
									<?php if($event->val('rsvp_display')==1 || $event->val('rsvp_display')==2 || $event->val('rsvp_display')==3){ ?>
										<p>
											<strong><?=  $joinersCount; ?> <?= ($event->hasEnded()) ? gettext("RSVP'd") : gettext('People going') ?></strong><br><br>
										</p>
									<?php } ?>
									<?php if($event->val('rsvp_display')==2 || $event->val('rsvp_display')==3 ){ ?>
										<?php if(count($eventJoiners)){ ?>
												<?php for($p=0;$p<count($eventJoiners);$p++){ ?>
													<?= User::BuildProfilePictureImgTag($eventJoiners[$p]['firstname'], $eventJoiners[$p]['lastname'], $eventJoiners[$p]['picture'],'memberpic2',sprintf(gettext('%s Profile Picture'),$eventJoiners[$p]['firstname']));?>
												<?php }?>
										<?php } ?>

									<?php } ?>



                    </div>
                </div>
               
            </div>

            <div id="web_conference_detail" class="modal fade">
              <div class="modal-dialog" aria-modal="true" role="dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" tabindex="0" id="location_modal_title"><?= sprintf(gettext('%s Details'), $event->val('web_conference_sp')) ?></h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    
                  </div>
                  <div class="modal-body modal-max-height">
                    <div class="col-md-12" id="conference_detail">
                      <?=$event->val('web_conference_detail')?>
                    </div>
                    <div class="clearfix"></div>
                  </div>
                  <div class="modal-footer text-center">
                    <button type="button" class="btn btn-primary" data-dismiss="modal"><?= gettext("Close"); ?></button>
                    </div>
                </div>
              </div>
            </div>
        </div>
    </div>
    <div id="loadAnyModal"></div>
    <?php if (!$external_user){
        include(__DIR__ . '/external_user_basic_information.template.php');
     } ?>
  <script>
  $('#web_conference_detail').on('shown.bs.modal', function () {
  $('#location_modal_title').trigger('focus');
  });

    function showWebConferenceDetail(){
      $('#web_conference_detail').modal('show');
    }

    function joinExternalEvent(i,s,r){
      let eventJoinSurveyResponse = (typeof r !== 'undefined') ? r : '';
      $.ajax({
        url: 'ajax.php?joinExternalEvent=1',
          type: "POST",
          data: {
            'eventid':i,
            'joinStatus' : s,
            'eventJoinSurveyResponse':eventJoinSurveyResponse
          },
          success : function(data) {
            try {
              let jsonData = JSON.parse(data);
              swal.fire({title:jsonData.title,text:jsonData.message})
              .then(function(result) {
                if(jsonData.status){
                  location.reload();
                } 
              });
            } catch(e) {
              // Nothing to do
              swal.fire({title: 'Error', text: "Unknown error."});
            }
          }
      });
    }

    function getPreJoinExternalEventSurvey(i,s){
      $.ajax({
        url: 'ajax.php?getPreJoinExternalEventSurvey=1',
          type: "GET",
          data: {'eventid':i,'joinStatus':s},
          success : function(data) {
            try {
              let jsonData = JSON.parse(data);
              swal.fire({title: jsonData.title, text: jsonData.message,allowOutsideClick:false});
            } catch(e) {
              $('#loadAnyModal').html(data);
              $('#eventSurveyModal').modal({
                backdrop: 'static',
                keyboard: false
              });
            }
          }
      });
    }

    function clearExternalEventSession(){
      $.ajax({
        url: 'ajax.php?clearExternalEventSession=1',
          type: "GET",
          data: {},
          success : function(data) {
            try {
              let jsonData = JSON.parse(data);
              swal.fire({title: jsonData.title, text: jsonData.message,allowOutsideClick:false})
              .then(function(result) {
                location.reload();
              });
            } catch(e) {}
          }
      });
    }

    $(document).ready(function () {
      <?php if (!$external_user){ ?>
        $('#externalUserInformation').modal({
					backdrop: 'static',
					keyboard: false
				});
        
      <?php } ?>

      $(document).ajaxStart(function () {
        ajaxindicatorstart('');
      }).ajaxStop(function () {
        ajaxindicatorstop();
      });

      $(".confirm").popConfirm({content: ''});
      
      //initial for blank profile picture
      $('.initial').initial({
          charCount: 2,
          textColor: '#ffffff',
          color: window.tskp?.initial_bgcolor ?? null,
          seed: 0,
          height: 50,
          width: 50,
          fontSize: 20,
          fontWeight: 300,
          fontFamily: 'HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif',
          radius: 0
      });

    });
    function ajaxindicatorstart(text) {
      $('body').css('cursor', 'wait');
    }
    function ajaxindicatorstop() {
      $('body').css('cursor', 'default');
    }
    
    

  </script>
  </body>
</html>