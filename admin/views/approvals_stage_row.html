<div class="col-md-12">
    <div class="widget-simple-chart card-box">
        <div class="col-md-12 divider">
            <h6>
                <?= $topicName; ?> Approvers - Stage <?= $approvalStage['approval_stage'] ?>
                <a aria-label="Add new Approver Stage <?= $approvalStage['approval_stage'] ?>" class="add-plus-circle-icon" href="addapprover?topicType=<?=$topicType?>&config_id=<?=$_COMPANY->encodeId($approvalStage['approval_config_id'])?>">
                    <i class="fa fa-plus-circle ml-2" title="Add new Approver" aria-hidden="true"></i>
                </a>
            </h6>

            <?php // The delete button will show for only the last stage ?>
            <?php if (!isset($globalConfigurationForAllStages[$k+1])) { ?>
            <button
              id="js-delete-approval-stage-btn"
              class="btn pull-right deluser"
              aria-label="Delete Approval Stage"
              title="Are you sure you want to delete this approval stage?"
              onclick="deleteApprovalStage()"
              data-approval_config_id="<?= $_COMPANY->encodeId($approvalStage['approval_config_id']) ?>"
              data-topic_type="<?= $topicType ?>"
            >
              <i class="fa fa-trash" title="Delete"  aria-hidden="true"></i>
            </button>
            <?php } ?>

            <button aria-label="Email configuration" class="btn btn-primary btn-sm pull-right"
               onclick="getApprovalEmailConfigurationModal('<?= $_COMPANY->encodeId($approvalStage['approval_config_id']) ?>','<?=$topicType?>');">
               Stage configuration
            </button>

            <?php if ($allowAutoApprovalConfiguration) { ?>
            <a href="topic_auto_approval_config?topicType=<?=$topicType?>&approval_stage=<?= $_COMPANY->encodeId($approvalStage['approval_stage']) ?>&approval_config_id=<?= $_COMPANY->encodeId($approvalStage['approval_config_id']) ?>" class="btn btn-primary btn-sm pull-right" style="margin-right: 10px;">
                Configure Auto-Approvals
            </a>
            <?php } ?>

            <?php if ($_COMPANY->getAppCustomization()[$appCustomizationTitle]['approvals']['tasks']) { ?>
            <a href="topic_approval_tasks?topicType=<?=$topicType?>&approval_stage=<?= $_COMPANY->encodeId($approvalStage['approval_stage']) ?>&approval_config_id=<?= $_COMPANY->encodeId($approvalStage['approval_config_id']) ?>" class="btn btn-primary btn-sm pull-right" style="margin-right: 10px;">
                Configure Tasks
            </a>
            <?php } ?>
        </div>
        <br>
        <div class="clearfix"></div>

        <div class="table-responsive ">
            <table id="approvers_stage_<?= $k ?>" class="table table-hover dyna_data_table display compact" summary="Approvers list">
                <thead>
                <tr>
                    <th scope="col">Approver Name</th>
                    <th scope="col">Approver Role Title</th>
                    <th scope="col">Job Title</th>
                    <th scope="col">Email</th>
                    <th scope="col">Action</th>
                </tr>
                </thead>
                <tbody>

                <?php
                $i = 0;
                foreach ($approvers as $approver) {
                    $approverData = User::GetUser($approver['approver_userid']);
                    if (!$approverData) {
                        // Auto healing feature, if the configured user is not found, remove it from the configuration.
                        $TopicClass::DeleteApproverFromApprovalConfiguration($approvalStage['approval_config_id'], $approver['approver_userid']);
                        continue;
                    }
                    ?>                             
                    <tr id="<?= $i + 1; ?>">
                        <td><strong><?= $approverData->getFullName(); ?></strong></td>
                        <td><?= $approver['approver_role']; ?></td>
                        <td><?= $approverData->val('jobtitle'); ?></td>
                        <td><?= $approverData->val('email'); ?></td>
                        <td style="text-align: right;">
                            <button aria-label="delete"  class="btn btn-no-style deluser" id="bdisable1"
                               onclick="deleteApprover(this.closest('tr'),'<?=$_COMPANY->encodeId($approvalStage['approval_config_id'])?>','<?= $_COMPANY->encodeId($approverData->id()); ?>')"
                               title="" data-original-title="<strong>Are you sure you want to delete!</strong>"><i
                                        class="fa fa-trash" title="Delete" aria-hidden="true"></i></button>&nbsp;
                        </td>
                    </tr>
                <?php $i++; } ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="<?=TELESKOPE_.._STATIC?>/vendor/js/datatables-2.1.8/datatables.min.js"></script>
<script>
    $(document).ready(function() {
        DataTable.ext.errMode = 'none'; // stop datatable warning message for only dynamic approval table in admin side.
        $("#approvers_stage_<?= $k ?>").DataTable( {
            "order": [],
            "bPaginate": true,
            "bInfo" : false,
            "columnDefs": [
                { targets: [-1], orderable: false }
		    ],	
            language: {
            searchPlaceholder: "...",
            url: '../vendor/js/datatables-lang/i18n/<?= $_COMPANY->getDatatableLanguage($_USER->val("language")); ?>.json'
          },

        } );

    } );

</script>

<script>
    function getApprovalEmailConfigurationModal(i,tt){
        $.ajax({
            url: 'ajax.php?getApprovalEmailConfigurationModal=1',
            type: "GET",
            data: {approval_config_id: i,topic_type:tt},
            success: function (data) {
                try {
                    let jsonData = JSON.parse(data);
                    swal.fire({title: jsonData.title, text: jsonData.message})
                } catch (e) {
                    $('#loadAnyModal').html(data);
                    $('#approvalEmailConfigModal').modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                }
            }
        });
    }

    function deleteApprovalStage() {
      var btn = $('#js-delete-approval-stage-btn');

      $.ajax({
        url: 'ajax.php?deleteApprovalStage=1',
        type: 'POST',
        data: {
          approval_config_id: btn.data('approval_config_id'),
          topic_type: btn.data('topic_type'),
        },
        tskp_submit_btn: btn,
        dataType: 'json',
        success: function (json) {
          Swal.fire({title: json.title, text: json.message}).then(function(result) {
            location.reload();
          });
        }
      });
    }
</script>
