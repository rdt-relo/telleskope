<style>

</style>
<div class="container col-md-offset-2 margin-top">
    <div class="row">              
        <div class="col-md-12">
            <div class="widget-simple-chart card-box">
                
                <div class="col-md-6 ">
                        <h6 style="margin-top: 4px;" ><?= $pagetitle; ?>&nbsp;</h6>
                    </div>
                    <div class="col-md-6 text-right">
                    <?php if($_COMPANY->getAppCustomization()['event']['speakers']['approvals']){ ?>
                        <button aria-label="Speaker Approval Configuration" class="btn btn-primary btn-sm" onclick="manageSpeakerApprovalConfiguration();">Speaker Approval Configuration</button>
                    <?php } ?>
                        <a class="btn btn-primary btn-sm" href="event_custom_fields?topictype=EVTSPK">Manage Event Speaker Fields</a>
                    </div>
                <div class="divider col-md-12 mb-3"></div>
                <div class="clearfix"></div>
            <?php if((time()- @$_SESSION['updated']) < 5){ ?>
                <div id="hidemesage" class="alert alert-info alert-dismissable">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">x</a>
                    <?= UPDATED; ?>
                </div>
            <?php }elseif((time()- @$_SESSION['error']) < 5){ ?>
                    <div id="hidemesage" class="alert alert-danger alert-dismissable">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">x</a>
                        <?= ERROR; ?>
                    </div>
            <?php } ?>
                <div class="col-md-12">
                    <div class="table-responsive " id="list-view">
                
                        <table id="eventCustomField" class="table table-hover display compact">
                            <thead>
                                <tr>
                                    <th width="20%">Speaker</th>
                                    <th width="30%">Event</th>
                                    <th width="15%">Event Date</th>
                                    <th width="5%">Speaker Fee</th>
                                <?php if($_COMPANY->getAppCustomization()['event']['speakers']['approvals']){ ?>
                                    <th width="15%">Approver</th>
                                <?php } ?>
                                    <th width="5%">Detail</th>
                                    <th width="10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                        <?php foreach($allSpeakers as $speaker){
                            $approver = null;
                            if ($speaker['approved_by']){
                                $approver = User::GetUser($speaker['approved_by']);
                            }                            
                        ?>
                            <tr id="<?= $_COMPANY->encodeId($speaker['speakerid'])?>">
                                <td>
                                    <strong><?= htmlspecialchars($speaker['speaker_name']); ?></strong><br/>
                                    <small><?= htmlspecialchars($speaker['speaker_title']); ?></small>
                                </td>
                                <td>
                                    <?php if ($speaker['collaborating_groupids']) {
                                        $event = Event::GetEvent($speaker['eventid']);
                                        $groupName = $event->getFormatedEventCollaboratedGroupsOrChapters();
                                    }else{
                                        $groupName = Group::GetGroupName($speaker['groupid']);
                                    }
                                    ?>
                                    <?= $speaker['eventtitle']; ?><br/>
                                    <small>in <?= $groupName; ?></small>

                                </td>
                                <td><?= $_USER->formatUTCDatetimeForDisplayInLocalTimezone($speaker['start'],true,true,true) ?></td>
                                <td>$<?= htmlspecialchars($speaker['speaker_fee']); ?></td>
                            <?php if($_COMPANY->getAppCustomization()['event']['speakers']['approvals']){ ?>
                                <td><?= $approver ? $approver->getFullName().'<br><small>('.$approver->val('email').')</small>': '-'; ?></td>
                            <?php } ?>
                                <td><button onclick="viewSpeakerDetail('<?= $_COMPANY->encodeId($speaker['eventid'])?>','<?= $_COMPANY->encodeId($speaker['speakerid'])?>')" class="btn btn-primary btn-sm">View</button></td>
                                <td>
                                    <div class="dropdown" id="action<?= $_COMPANY->encodeId($speaker['speakerid'])?>">
                                        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <?= $approvalStatus[$speaker['approval_status']]?>
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        
                                        <?php if($_COMPANY->getAppCustomization()['event']['speakers']['approvals']){ ?>

                                            <?php if($speaker['approval_status']==1) { ?>
                                                <button aria-label="Assign To" class="btn-no-style dropdown-item" onclick="assignUserForSpeakerApprovelModal('<?= $_COMPANY->encodeId($speaker['eventid'])?>','<?= $_COMPANY->encodeId($speaker['speakerid'])?>')" class=""><i class="fa fa-user-plus" aria-hidden="true"></i> Assign To</button>
                                            <?php } ?>

                                            <?php if ($speaker['approval_status'] != 3 ) { ?>
                                                <button aria-label="Approve" class="btn-no-style dropdown-item deluser" onclick="updateEventSpeakerStatusModal('<?= $_COMPANY->encodeId($speaker['eventid'])?>','<?= $_COMPANY->encodeId($speaker['speakerid'])?>',3,'<?= $speaker['approver_note']; ?>')" class="confirm" title="Are you sure you want to approve this speaker?"><i class="fa fa-check-circle" aria-hidden="true"></i> Approve</button>
                                            <?php } ?>

                                            <?php if ($speaker['approval_status'] != 4 ) { ?>
                                                <button aria-label="Deny" class="btn-no-style dropdown-item deluser" onclick="updateEventSpeakerStatusModal('<?= $_COMPANY->encodeId($speaker['eventid'])?>','<?= $_COMPANY->encodeId($speaker['speakerid'])?>',4,'<?= $speaker['approver_note']; ?>')" class="confirm" title="Are you sure you want to reject this speaker?"><i class="fa fa-ban" aria-hidden="true"></i> Deny</button>
                                            <?php } ?>
                                        <?php } ?>

                                            <button aria-label="Delete" class="btn-no-style dropdown-item deluser" onclick="deleteEventSpeaker('<?= $_COMPANY->encodeId($speaker['eventid'])?>','<?= $_COMPANY->encodeId($speaker['speakerid'])?>')" class="confirm" title="Are you sure you want to delete this speaker?"><i class="fa fa-trash" aria-hidden="true"></i> Delete</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <?php } ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="speakerDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Speaker Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="col-md-12 text-left" id="speakerDetail">
              
          </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="clearInterval(__globalIntervalVariable);">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="approvalNoteModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Approver Note:</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <form id="approvalForm">
                <input type="hidden" id="approvalEventid" name="approvalEventid">
                <input type="hidden" id="approvalSpeakerid" name="approvalSpeakerid">
                <input type="hidden" id="approvalStatus" name="approvalStatus">
                <div class="form-group">
                    <label >Note</label>
                    <textarea  class="form-control" maxlength="1000" id="approverNote" name="approverNote" placeholder="Approver note."></textarea>
                    <small style="color:red">Maximum 1000 characters allowed!</small>
                </div>
            </form>
        </div>
        <div class="text-center mb-5">
                <button type="button" onclick="updateEventSpeakerStatus()"  class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script src="../vendor/js/datatables-2.1.8/datatables.min.js"></script>
<script>
    $('#eventCustomField').DataTable({
        "order": [],
        "bPaginate": true,
        "bInfo" : false,  
        "columnDefs": [
            { targets: [-1,-2], orderable: false }
        ],      
        language: {
            searchPlaceholder: "...",
            url: '../vendor/js/datatables-lang/i18n/<?= $_COMPANY->getDatatableLanguage($_USER->val("language")); ?>.json'
        },        
    });
    $(document).ready(function(){
        $('.initial').initial({
            charCount: 2,
            textColor: '#ffffff',
            seed: 0,
            height: 30,
            width: 30,
            fontSize: 15,
            fontWeight: 300,
            fontFamily: 'HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif',
            radius: 0
        });
    });
    function updateEventSpeakerStatus(){
        var e = $("#approvalEventid").val();
        var s = $("#approvalSpeakerid").val();
        var a = $("#approvalStatus").val();
        var n =  $("#approverNote").val();
        $.ajax({
            url: 'ajax.php?updateEventSpeakerStatus=1',
            type: "post",
            data: {eventid:e,speakerid:s,action:a,note:n},
            success : function(data) {
                if(data == 1){
                    swal.fire({title: 'Success',text:"Updated successfully"}).then(function (result) {
                        location.reload();
                    });
                } else {
                    swal.fire({title: 'Error!',text:"Something went wrong. Please try again"});
                }
                setTimeout(() => {
                    $(".swal2-confirm").focus();
                }, 200)
            }
        });

    }
    function deleteEventSpeaker(e,s){
        $.ajax({
            url: 'ajax.php?deleteEventSpeaker=1',
            type: "post",
            data: {eventid:e,speakerid:s},
            success : function(data) {
                if(data){
                    $("#"+s).animate({ backgroundColor: "#fbc7c7" }, "fast").animate({ opacity: "hide" },  2000);
                } else {
                    swal.fire({title: 'Error!',text:"Something went wrong. Please try again"});
                }
            }
        });
    }

    function updateEventSpeakerStatusModal(e,s,a,n){
        $("#approvalEventid").val(e);
        $("#approvalSpeakerid").val(s);
        $("#approvalStatus").val(a);
        $("#approverNote").val(n);
        $('#approvalNoteModal').modal({
            backdrop: 'static',
            keyboard: false
        });
    }
</script>
</body>
</html>
